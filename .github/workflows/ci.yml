name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: node test/test.js

      - name: Transpile all examples
        run: |
          echo "Transpiling .kimchi files..."
          for file in examples/*.kimchi; do
            if [ -f "$file" ]; then
              echo "  Compiling $file"
              node src/cli.js compile "$file" -o "${file%.kimchi}.js"
            fi
          done
          
          echo "Transpiling .km files..."
          for file in examples/*.km; do
            if [ -f "$file" ]; then
              echo "  Compiling $file"
              node src/cli.js compile "$file" -o "${file%.km}.js"
            fi
          done
          
          echo "Transpiling nested .km files..."
          find examples -name "*.km" -type f | while read file; do
            echo "  Compiling $file"
            node src/cli.js compile "$file" -o "${file%.km}.js"
          done

      - name: Run example files
        run: |
          echo "Running examples..."
          node src/cli.js run examples/hello.kimchi
          node src/cli.js run examples/fibonacci.kimchi
          node src/cli.js run examples/basic.kimchi
          node src/cli.js run examples/new_features.kimchi
          node src/cli.js run examples/memo_fibonacci.km
          node src/cli.js run examples/stdlib_test.km
          echo "All examples ran successfully!"
